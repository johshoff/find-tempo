<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv='Content-type: text/html; charset=utf-8'>
		<meta charset='utf-8'>
		<title></title>
		<!--link rel='stylesheet' type='text/css' href='style.css'></link-->
		<script type='text/javascript' src='d3.min.js'></script>
		<style type='text/css'>
		body {
			font-family: gill sans, helvetica, arial, sans-serif;
		}
		table {
			border-collapse: collapse;
		}
		.measurements {
			border-spacing: 0px;
		}
		.measurements tr :nth-child(2) {
			text-align: right;
			min-width: 5em;
		}
		.submission input {
			width: 300px;
		}
		td, th {
			padding-right: 1em;
		}
		h3 {
			margin-top: 3em;
		}
		#songlist {
			background: #eee;
		}
		#songlist tr:nth-child(odd) {
			background: #ddd;
		}
		#songlist a {
			color: #338;
			text-decoration: none;
		}
		</style>
		<script type='text/javascript'>
			var samples = [];
			var symbol_off_timeouts = 0;

			var json_host = (document.location.hostname === "johanneshoff.com") ? 'http://find-tempo.herokuapp.com/' : '';

			onkeydown = function(ev)
			{
				if (!ev.altKey)
					return;

				samples.push(new Date());
				var sum_delta = 0;
				var sum_bpm = 0;
				var count_delta = 0;
				var all_deltas = [];
				for (i in samples)
				{
					if (i > 0)
					{
						var delta_ms = samples[i] - samples[i-1];
						all_deltas.push(delta_ms);
						count_delta++;
						sum_delta += delta_ms;
						sum_bpm += 60000 / delta_ms;
					}
				}

				document.getElementById('beat-symbol').setAttribute('fill', '#a81');
				symbol_off_timeouts += 1;
				setTimeout(function() {
					symbol_off_timeouts -= 1;
					if (symbol_off_timeouts == 0)
						document.getElementById('beat-symbol').setAttribute('fill', 'none');
				}, 100);

				if (samples.length < 2)
					return;

				var avg_delta_ms = (sum_delta / count_delta);
				document.getElementById('bpm-avg-delta').innerText = (60000 / avg_delta_ms).toFixed(1);

				var avg_bpm = (sum_bpm / count_delta);
				document.getElementById('bpm-avg-bpm').innerText = avg_bpm.toFixed(1);

				all_deltas.sort();
				document.getElementById('bpm-median').innerText = (60000 / all_deltas[Math.floor(all_deltas.length / 2)]).toFixed(1);
			}
			save = function(button)
			{
				button.disabled = true;

				var data = {
					uri          : document.getElementById('spotify-uri'  ).value,
					notes        : document.getElementById('notes'        ).value,
					author       : document.getElementById('author'       ).value,
					bpm_avg_delta: parseFloat(document.getElementById('bpm-avg-delta').innerText),
					bpm_avg_bpm  : parseFloat(document.getElementById('bpm-avg-bpm'  ).innerText),
					bpm_median   : parseFloat(document.getElementById('bpm-median'   ).innerText)
				};

				d3.xhr(json_host+'bpms').post(JSON.stringify(data), function (err, data) {
					if (err)
					{
						button.disabled = false;
						alert('Failed saving');
						return;
					}
					console.log(data);
					refresh_list(function() {
						button.disabled = false;
					});
				});
			}
			restart = function()
			{
				samples = [];
				document.getElementById('bpm-avg-delta').innerText = '?';
				document.getElementById('bpm-avg-bpm')  .innerText = '?';
				document.getElementById('bpm-median')   .innerText = '?';
			}
			var author_key = 'bpm_author_name';
			savename = function(name)
			{
				localStorage[author_key] = name;
			}
			onload = function()
			{
				var author = localStorage[author_key];
				if (author)
					document.getElementById('author').value = author;
			}
			refresh_list = function(callback)
			{
				d3.json(json_host+'bpms', function (err, json) {
					if (err)
					{
						return console.warn('Could not load data');
					}
					else
					{
						var table = d3.select('#songlist');//.append('table');
						var enter_node = table.selectAll('.entry').data(json, function (d) { return d.id; }).enter().append('tr');

						enter_node.attr('class', 'entry');
						enter_node.append('td').text(function (d) { return d.artist; });
						enter_node.append('td').append('a').attr('href', function (d) { return d.uri.replace(/:/g, '/').replace(/^spotify/, 'http://open.spotify.com'); })
			                       	   	   	   .text(function (d) { if (d.title) return d.title; else return d.uri; });
						enter_node.append('td').text(function (d) { return d.bpm_avg_delta; });
						enter_node.append('td').text(function (d) { return d.bpm_avg_bpm; });
						enter_node.append('td').text(function (d) { return d.bpm_median; });
						enter_node.append('td').text(function (d) { return d.notes; });
					}

					if (callback)
						callback();
				});
			}
		</script>
		<script type="text/javascript">
  	  	  var _gaq = _gaq || [];
  	  	  _gaq.push(['_setAccount', 'UA-3865201-3']);
  	  	  _gaq.push(['_trackPageview']);
		</script>
	</head>
	<body>
		<p><em>Press ALT to sample a beat</em>
		<table class='measurements'>
			<tr><th>Method         <th>BPM
			<tr><td>Avgerage delta <td><span id="bpm-avg-delta">?</span>
			<tr><td>Avgerage bpm   <td><span id="bpm-avg-bpm">?</span>
			<tr><td>Median bpm     <td><span id="bpm-median">?</span>
		</ul>
		</table>
		<input type="button" value="restart" onclick="restart(this)">
		<p>
		<svg height="30" width="30">
  	  	  <circle id='beat-symbol' cx="50%" cy="50%" r="45%" stroke-width="0" fill=none />
		</svg>

		<p>

		<table class="submission">
			<tr><td><label for='spotify-uri'> Spotify URI:          </label> <td><input id='spotify-uri'></input>
			<tr><td><label for='notes'>       Notes:                </label> <td><input id='notes'></input>
			<tr><td><label for='author'>      Your name (optional): </label> <td><input id='author' onchange="savename(this.value)"></input>
			</table>
		<input type="button" value="save bpm" onclick="save(this)">

		<h3>Most recently BPMed</h3>
		<table id='songlist'>
			<tr><th>Artist<th>Title<th>Avg Delta<th>Avg BPM<th>Median<th>Notes
		</table>

		<script type="text/javascript">
		refresh_list();
		</script>
		<script type="text/javascript">
		if (document.location.hostname !== "0.0.0.0" && document.location.hostname !== "127.0.0.1")
		{
			(function() {
			 	 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			 	 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			 	 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			 })();
		}
		</script>
	</body>
</html>
